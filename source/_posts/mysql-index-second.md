---
title: 聚簇索引与非聚簇索引
date: 2020-05-24 01:20:45
tags: MySQL 
---

> 本文基于 MySQL 5.7 (10.1.9-MariaDB)

<!-- more -->

### 一. 区分
- 聚簇索引( Clustered Index )，将索引与数据放到了叶子节点行中一起存储，找到索引也就找到了数据。
- 非聚簇索引 (Non - Clustered Index)，也叫二级索引 (secondary index)，将索引和数据分开存储，索引结构的叶子节点只有数据的指针，指向了对应的数据行。


### 二. 结构
聚簇索引和非聚簇索引的结构都是采用 B+树结构

### 三. 使用
MyISAM 引擎的索引和数据是分开两个文件 MYD 和 MYI 保存的，所以只有非聚簇索引。
InnoDB 引擎既有聚簇索引，也有非聚簇索引，而且都保存在 idb 文件中，只是数据结构不一样而已。

### 四. InnoDB 的聚簇索引

##### 1. 创建
- 因为一个表中数据的存放方式只有一种，所以一个表只能有一个聚簇索引。
- 聚簇索引默认就是自增ID的主键索引，没有主键时，会用一个唯一且不为空的索引列做为聚簇索引。
- 如果没有这样的索引，InnoDB 会隐式定义一个主键来作为聚簇索引。

##### 2. 优点
- 因为索引和数据保存在一起，所以找到索引就找到了数据，查询一次即可获得数据。
- 如果是自增ID作为主键作为聚簇索引，那么对应的数据一定也是相邻地存放在磁盘上的，写入性能比较高。如果类似 uuid 跳跃的数值作为聚簇索引，频繁的插入会使 InnoDB 频繁地移动磁盘块，写入性能就比较低了。 

##### 3. 缺点
 - 查询时，需要把索引和数据一起加载到内存，会影响性能，所以聚簇索引采取 B+树结构，只将一个父节点下的子节点加载到内存，然后再通过子节点的双向链表搜索更多的数据。


### 五. InnoDB 的非聚簇索引

##### 1. 创建
- 非聚簇索引可以有多个，比如唯一索引，普通索引，以及组合索引等。
- 非聚簇索引的子节点只保存了当前索引值以及数据指针。

##### 2. 优点
- 因为非聚簇索引只是索引结构，没有真实数据，所以在大数据量的排序、全表扫描、count之类的场景，只需将索引树加载到内存就能完成，效率更高。
- 如果 select 的字段就是索引值，只需要遍历一次非聚簇索引即可获得数据。比如 select name from test_index, 其中 name 就是索引列。

##### 3. 缺点
- 因为非聚簇索引只保存了数据指针，如果 select 的字段是非索引值，还得再遍历一次聚簇索引的才能获取真实数据，此过程叫做回表。而当执行 select pId,name from test_index where name = ?, 且 name 上有索引的时候，效率比执行 select * from test_index where name = ? 速度快好几倍，因为不需要回表。
- 多加一个索引，就会多生成一颗非聚簇索引树。因为有几个索引，就有几颗非聚簇索引树！在做插入操作的时候，需要同时维护这几颗树的变化！因此，如果索引太多，插入性能就会下降!

```sql
mysql> show create table test_index;
+------------+------------------------------------------------------------------
| Table      | Create Table
---------------------------------------------------------+
| test_index | CREATE TABLE `test_index` (
  `pId` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(100) DEFAULT NULL,
  `birthday` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`pId`),
  KEY `name` (`name`)
) ENGINE=InnoDB AUTO_INCREMENT=14 DEFAULT CHARSET=utf8 |
---------------------------------------------------------+
1 row in set (0.00 sec)

mysql> select * from test_index ;
+-----+----------+---------------------+
| pId | name     | birthday            |
+-----+----------+---------------------+
|   5 | zhangsan | 2020-05-24 00:56:44 |
|   8 | lisi     | 2020-05-24 00:56:54 |
|  11 | wangwu   | 2020-05-24 00:57:03 |
|  13 | zhaoliu  | 2020-05-24 00:57:12 |
+-----+----------+---------------------+
4 rows in set (0.00 sec)

```

![](/img/2020/mysql_data_b_two.jpg)

![](/img/2020/mysql_data_b_three.jpg)