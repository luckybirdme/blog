---
title: nodejs 特点
date: 2019-12-23 08:52:35
tags: nodejs
---

> nodejs 是一个 Javascript 运行环境，依赖于 Chrome V8 引擎进行 js 代码解释，它采用事件驱动和非阻塞I/O机制，合适轻量、可伸缩，适于实时数据交互应用。

<!-- more -->

## 一. 简介
#### nodejs 是一个 Javascript 运行环境，依赖于 Chrome V8 引擎进行 js 代码解释，它采用事件驱动和非阻塞I/O机制，合适轻量、可伸缩，适于实时数据交互应用。

#### 1. nodejs 系统框架
![](/img/2019/nodejs-0.png)

- Application : 这部分是由 Javascript 编写的，即我们的应用程序。
- V8：Google 推出的 Javascript VM，提供了在非浏览器端运行的环境下，解析并执行 JavaScript。
- Node bindings : 这一层是 Javascript 与底层 C/C++ 能够沟通的关键，前者通过此接口与操作系统进行交互。
- Libuv：它为 Node.js 提供了跨平台的异步 I/O 能力，Linux平台底层是利用 epoll 多路复用IO，只关心活跃文件描述符，回调式处理事件，并且采用红黑树维护任务队列，算法复杂度O(log(N))。

#### 2. nodejs 运行机制
![](/img/2019/nodejs-1.png)

- 每个Node.js进程只有一个主线程在执行程序代码，形成一个执行栈（execution context stack)。
- 主线程之外，还维护了一个"事件队列"（Event queue）。当用户的网络请求或者其它的异步操作到来时，node都会把它放到Event Queue之中，此时并不会立即执行它，代码也不会被阻塞，继续往下走，直到主线程代码执行完毕。
- 主线程代码执行完毕完成后，然后通过Event Loop，也就是事件循环机制，开始到Event Queue的开头取出第一个事件，从线程池中分配一个线程去执行这个事件，接下来继续取出第二个事件，再从线程池中分配一个线程去执行，然后第三个，第四个。主线程不断的检查事件队列中是否有未执行的事件，直到事件队列中所有事件都执行完了，此后每当有新的事件加入到事件队列中，都会通知主线程按顺序取出交EventLoop处理。当有事件执行完毕后，会通知主线程，主线程执行回调，线程归还给线程池。
- 主线程不断重复上面的第三步。

#### 3. 主要特性
- 高并发连接 : 每个连接发射（emit）一个在 NodeJS 引擎进程中运行的事件（Event），放进事件队列当中等待执行（EventLoop），因此可以快速地接收高并发连接。
- I/O 密集型 : 主线程轮询任务队列，遇到 I/O 事件分配给底层线程池执行，不会阻塞当前 I/O ，等 I/O 操作结束再执行回调函数（callback），因此合适密集型 I/O 的应用。

#### 4. 缺点
- 不适合CPU密集型应用：由于JavaScript单线程的原因，如果有长时间运行的计算（比如大循环），将会导致CPU时间片不能释放，使得后续I/O无法发起。
解决方案：分解大型运算任务为多个小任务，使得运算能够适时释放，不阻塞I/O调用的发起；

- 单线程不能充分利用拥有多个 CPU 的服务器。
解决方案：通过 child_process 创建子进程，将计算任务分发到子进行中，充分利用多个CPU。

- 单线程运行可靠性低，一旦代码某个环节崩溃，整个系统都崩溃。
解决方案：Nnigx反向代理，负载均衡，开多个进程，绑定多个端口；

- 大内存的应用，由于V8引擎有内存设计的限制，32位环境中最大堆是1G，64位环境中最大堆也不到2G，如果要一次读入10G数据，对于Nodejs来说也无法实现。
解决方法：还是使用 Java 和 C/C++ 吧。

- js 合适处理 json 格式的数据，比如文档型数据库 MongoDB，但是对于关系型数据库，则需要经过复杂的转换。
解决方法：如果可以，使用文档型数据库。



## 二. 应用场景

#### NodeJS适合运用在高并发、I/O密集、少量业务逻辑的场景，具体案例如下：

#### 1. 即时聊天工具 ( socket.io )
聊天室是典型的实时、多用户应用，轻量化、高流量，数据密集型，处理时间短，最简单做一次转发，同时考虑跨终端，不仅在浏览器，还能在APP上使用。它包含了大多数在一个典型的Node.js应用中用到的模式。


#### 2. Restfull API
这是NodeJS最理想的应用场景，可以处理数万条连接，本身没有太多的逻辑，只需要请求API，组织数据进行返回即可。它本质上只是从某个数据库中查找一些值并将它们组成一个响应。由于响应是少量文本，入站请求也是少量的文本，因此流量不高，一台机器甚至也可以处理最繁忙的公司的API需求。
不讨论这种架构是好是坏，但是有另外一种实践，面向服务的架构，更好的做前后端的依赖分离。如果所有的关键业务逻辑都封装成REST调用，就意味着在上层只需要考虑如何用这些REST接口构建具体的应用。那些后端程序员们根本不操心具体数据是如何从一个页面传递到另一个页面的，他们也不用管用户数据更新是通过Ajax异步获取的还是通过刷新页面。

#### 3. 前端构建工具 ( hexo, vue-cli )
Hexo 是一个简单地、轻量地、基于Node的一个静态博客框架。通过Hexo我们可以快速创建自己的博客，仅需要几条命令就可以完成。
vue-cli 是目前流行的前端框架 vuejs 的脚手架，方便构建 vuejs 的开发环境，集成了打包工具，服务 server 等。

#### 4. Web 网站开发 ( Express + EJS + MongoDB)
express 是轻量灵活的Nodejs Web应用框架，它可以快速地搭建网站。Express框架建立在Nodejs内置的Http模块上，并对Http模块再包装，从而实际Web请求处理的功能。
ejs是一个嵌入的Javascript模板引擎，通过编译生成HTML的代码。
mongoose 是MongoDB的对象模型工具，通过Mongoose框架，可以进行访问MongoDB的操作。