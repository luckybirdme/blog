---
title: 因特网
date: 2020-05-16 13:07:19
tags: Linux
---

> 因特网


<!-- more -->

### 一. 局域网通信

##### 1. 两台主机通信
局域网内通过网线直连，两台主机都知道对方的 MAC 地址，可以直接通信。

![](/img/2020/media_one.png)


##### 2. 三台以上的主机通信
如果主机跟所有要通信的主机都网线直连，会变得复杂且耗费资源，可借助集线器作为中转，统一关联。


![](/img/2020/media_two.png)


##### 3. 从集线器到交换机
- 集线器是通过广播的方式传递数据包，所有主机都能收到，如果 MAC 地址跟本机一样，就接收数据包。广播式的缺点是让局域网充满数据包，容易引发数据包冲突。
- 交换机维护了一份 MAC 地址和主机网线接口的映射表，可以根据不同 MAC 地址转发数据包到具体的主机网线接口，避免了集线器广播式传递的缺点
- 因为交换机需要跟所有主机网线相连，所以机房里插满各种网线的，一般都是交换机；交换机工作在 OSI 的链路层，即第二层，所以也叫二层交换机。


![](/img/2020/switch_five.jpg)


![](/img/2020/media_three.png)


![](/img/2020/media_four.png)


##### 4. 交换机的困境

- 集线器和交换机只能解决当前局域网的通信，对于其他局域网可以使用更大的交换机，组成更大局域网。
- 主机越多，交换机上需要相连的主机网线越来越多，MAC 地址和主机网线接口的关系表也会越来越大。
- 当主机设备指数上升时，交换机不太可能将所有主机网线都插上，也不可能保存那么多 MAC 地址。
- 最头痛一点，是交换机存在单机风险，如果交换机出现了问题，那么整个局域网都会挂掉。

![](/img/2020/switch_two.jpg)


### 二. 广域网通信

##### 1. IP 地址
- 为了解决交换机的困境，就出现了 IP(Internet Protocol) 协议，每台主机绑定一个 IP 地址，局域网的主机 IP 是有规律的，比如 192.168.0.1,192.168.0.2,192.168.0.3
- 当需要访问 IP 地址为 192.168.0.3 的主机时，根据 IP 地址前缀，就能大致找到主机的所在位置，即所在的局域网，然后找到该局域网的交换机，最后交换机再找到具体主机。
- 那么局域网内的交换机，只需要保存本局域网内的主机 MAC 地址即可，无需关注其他局域网的主机 MAC 地址。

##### 2. 网关
- 如何判断将要访问的 IP 地址是局域网内的主机，还是其他局域网的主机呢？这时候就轮到网关出场了。
- 网关协议规定一台主机，必须分配三个信息：内网 IP 地址，子网掩码，网关地址，比如主机 A 的 IP 地址 192.168.1.3，子网掩码 255.255.255.0，默认网关地址 192.168.1.1。
- 此时主机 A 想要访问主机 B 的 IP 地址 192.168.2.4，将主机 A 和主机 B 的 IP 地址分别与主机 A 的子网掩码做 "与"操作，发现是 A(192.168.1.0)!=B(192.168.2.0)，因此主机 A 和主机 B 不在同一个局域网。
- 如果主机 B 不在当前主机 A 的局域网，所以主机 A 的访问请求将会转发到网关地址 192.168.1.1；因为主机 A 和网关是在同一个局域网，所以直接通过交换机的 MAC 地址转换就传递数据包。
- 网关收到主机的 A 数据包后，发现访问的 IP 地址是其他局域网的主机 B，就往更大的局域网传递，这个更大局域网就是广域网，也是我们常说的因特网。
- 网关是局域网的大门，进出局域网都必须经过它；因此网关是局域网之间通信的关键所在。


```shell
无线局域网适配器 无线网络连接:
   连接特定的 DNS 后缀 . . . . . . . :
   本地链接 IPv6 地址. . . . . . . . : fe80::c928:5ea5:97be:2813%12
   IPv4 地址 . . . . . . . . . . . . : 192.168.0.100
   子网掩码  . . . . . . . . . . . . : 255.255.255.0
   默认网关. . . . . . . . . . . . . : 192.168.0.1
```

![](/img/2020/media_six.png)


##### 4. 路由器
- 网关之间的数据包具体是往哪里传递呢，怎么找到主机 B 所在的局域网的网关呢？这时候就轮到路由器出场了。
- 需要说明下，网关只是概念词，路由器是实体物品，可以理解路由器实现了网关的功能，但路由器更重要的功能是路由寻找和转发。
- 路由器维护了一份目的IP地址和对应网关地址的映射表，即路由表；路由器收到链路层传来的数据包后，会解析出目的IP地址，然后根据路由表的映射关系，找到最合适的下一个的网关地址 (Gateway)，并通过 ARP (Address Resolution Protocol) 协议把数据包的 MAC 地址改成下一个网关地址的 MAC 地址，然后从指定端口(Interface)传递出去。
- 下一个网关地址也有一个路由器，当收到上一个路由器转发的数据包后，也做了类似的动作，解析数据包拿出目的 IP 地址，匹配路由表确定下一个网关地址，即路由器。以此类推，转发下去，直到有路由器发现网关地址就是自己所在局域网的网关地址，或者数据包超过了生成时间 ttl，即 time to live，经过路由器的数量上限，最大为 255 (8 bit)。
- 路由器把数据包转发给本地的网关地址，网关把数据包再给交换机，交换机就能根据 MAC 地址找到具体的主机 B 了。
- 路由器匹配路由表时，可能存在多条可达的网关地址记录，因此可达路由会存在多条，就好像多条星状路线一样，经过多个路由节点，都能达到目标机器，不存在核心，也就没有交换机那种单机故障的风险了。
- 每台主机也有自己的本地路由表，不过表里可能只存了本机到交换机的路由信息。


```shell
Routes:  
Network Destination    Netmask           Gateway          Interface        Metric  
0.0.0.0                0.0.0.0           192.168.123.254  192.168.123.88   1  
0.0.0.0                0.0.0.0           192.168.123.254  192.168.123.68   1  
127.0.0.0              255.0.0.0         127.0.0.1        127.0.0.1        1  
192.168.123.0          255.255.255.0     192.168.123.68   192.168.123.68   1  
192.168.123.0          255.255.255.0     192.168.123.88   192.168.123.88   1  
192.168.123.68         255.255.255.255   127.0.0.1        127.0.0.1        1  
192.168.123.88         255.255.255.255   127.0.0.1        127.0.0.1        1  
192.168.123.255        255.255.255.255   192.168.123.68   192.168.123.68   1  
192.168.123.255        255.255.255.255   192.168.123.88   192.168.123.88   1  
224.0.0.0              224.0.0.0         192.168.123.68   192.168.123.68   1  
224.0.0.0              224.0.0.0         192.168.123.88   192.168.123.88   1  
255.255.255.255        255.255.255.255   192.168.123.68   192.168.123.68   1  
Default Gateway: 192.168.123.254  

```

![](/img/2020/media_seven.png)


![](/img/2020/switch_three.jpg)




##### 5. 三层交换机
- 路由器是工作在交换机之上，而且是以 IP 协议进行数据转发，OSI 模型定义了路由器的工作层为网络层，即第三层。
- 交换机以 MAC 地址转发数据，工作在链路层，即第二层；如果交换机也实现了类似 IP 协议的路由转发，那就是三层交换机，合适在较大的局域网连接多个子局域网。


##### 5. IP 地址分类

- 刚才说到的 IP 协议，一般是只 IPv4 (Internet Protocol version4，IPv4) 协议，主要特点之一是采用 4 个字节表示 IP 地址，比如 192.168.1.2，最多有 2^32 个 IP，还要除去一些特殊功能的IP。
- IP 地址由网络地址和主机地址组成，网络地址用于识别主机所在的局域网，主机地址用于识别该局域网中的主机，给定一个 IP 地址(192.168.1.3)和子网掩码(255.255.255.0)，将 IP 地址与子网掩码做"与"操作，就得到网络地址(192.168.1.0)
- IP 主要分为 5 大类，每一类的网络地址和主机地址都不同。


```shell
# 子网掩码
255.255.255.0
# 转为二进制，网络地址有24位，主机地址有8位
11111111 11111111 11111111 00000000
# IP 地址与子网掩码做"与"操作
192.168.1.3
# 获得IP地址的网络地址
192.168.1.0
```

![](/img/2020/ipv4_type.jpg)

分类|范围
-|-
A|0 开头，即 1.0.0.1 - 126.255.255.254
B|10 开头，即 128.1.0.1 - 191.255.255.254
C|110 开头，即 192.0.1.1 - 223.255.255.254
D|1110 开头，即 224.0.0.1 - 239.255.255.254
E|1111 开头，即 255.0.0.0.0 - 255.255.255.255
私有|10.0.0.0 - 10.255.255.255 ; 172.16.0.0 - 172.31.255.255 ; 192.168.0.0 - 192.168.255.255
回路测试|127.0.0.1 - 127.255.255.255


##### 6. IPv4 地址的困境
- 每个主机设备都要绑定一个全球唯一的 IP 地址，目前 IPv4 的 IP 资源已经将近枯竭，考虑到这个问题，就有 NAT (Network Address Translation) 网络技术，通过共享出口网络 IP 地址的方式，让局域网的主机只需配置私有网络的 IP 地址，就可以访问外网。
- 其实更好的解决方法是使用最新的 IPv6 协议，它是通过 16 个字节表示 IP 地址，那就有 2^168 个，几乎用不完了。




### 三. NAT, Network Address Translation

##### 1. 原理
- 局域网的主机A(192.168.1.1)，访问外网主机B(202.20.65.5)，由于主机A是局域网地址，属于私有网络，外网是无法识别的。
- 通过 NAT 技术，将主机A的私有IP地址转换为公网IP(202.20.64.4)，然后再去访问主机B，此时才能被外网识别。

![](/img/2020/nat_one.png)

##### 2. NAT 分类
- 静态 NAT ( Static NAT )（ 一对一 ）
将内部网络的私有IP地址转换为公有IP地址，IP地址对是一对一的，是一直不变的。
此方法的缺点是，需要为每个私有IP地址，配置一个公网IP。

![](/img/2020/nat_one.jpg)


- 动态地址 NAT ( Pooled NAT )（多对多）
将内部网络的私有 IP 地址转换为公用 IP 地址时，公网 IP 地址是不确定，从有限个公网IP池里随机分配。
此方法在一定程度上解决了公网IP短缺的问题，但是如果多个私有IP需要同时访问外网，也无能为力。

![](/img/2020/nat_two.jpg)



- 网络地址端口转换 NAPT（Network Address Port Translation）（Port-Level NAT）（ 多对一 ）
所有内网主机共用一个公网 IP，但是改变外出数据包的源端口并进行端口转换，利用不同端口来区分不同的内网主机。
只要 NAPT 的端口足够多，就能映射足够的内网主机，所以一个公网IP就够用了，此方法也是目前最常用的 NAT 方法。

![](/img/2020/nat_three.jpg)



##### 3. NAT 和 Proxy 区别
- NAT 工作在网络层，即第三层，跟路由器同一层，Proxy 一般是工作在应用层，即第七层，比如 NGINX
- 从性能上讲，NAT 不需要继续往上层解包和装包，所以效率会比 Proxy 更高。
- 从功能上讲，因为 Proxy 有更多的自定义空间，所以功能会比 NAT 更丰富。


### 四. 主机自动接入

##### 1. 局域网内主机
- 主机启动后，通过 DHCP (Dynamic Host Configuration Protocol) 协议，向局域网的DHCP 服务器申请IP地址，子网掩码，网关地址，以及 DNS 信息等，拥有 IP 地址后，才能跟局域网的其他主机和外网主机通信。
- DHCP 协议工作在传输层，采用 UDP 协议。

##### 2. 家庭路由器
- 家里买了路由器，一般有 5 个插口，一个 WLAN，宽带的网线就是插在这个口，是路由器与公网通信的接口；另外还有 4 个 LAN，你使用的电脑的网线就插这个口，是路由器与私有网络通信的接口。
- 当你的电脑网线查到路由器时，也会向路由器的 DHCP 服务器申请IP地址，子网掩码，网关地址，一般是设置成自动获取，你也可以自己设置，一般是 192.168.0.1 开头的私有地址。
- 当你的电话获取到 IP 地址后，电脑和路由器就组成了家庭式的局域网，电脑就能通过路由器访问外网了，此时路由器实现了网关，NAT，路由等功能。
- 之所以家庭局域网没有用到交换机，是因为一般不需要你的电脑访问你老婆的电脑，即局域网内机器互相访问。


```shell

[root@VM_133_231_centos ~]# ifconfig            
eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 10.135.133.231  netmask 255.255.192.0  broadcast 10.135.191.255
        ether 52:54:00:92:d9:8b  txqueuelen 1000  (Ethernet)

```


![](/img/2020/media_five.png)
