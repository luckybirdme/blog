---
title: MySQL 架构
date: 2020-04-05 15:13:20
tags: MySQL
---

> 本文基于 MySQL 5.7 (10.1.9-MariaDB)

<!-- more -->


## 一. MySQL 逻辑架构
![](/img/2020/MySQL.png)

### 1. 连接层(Client Connectors)：
最上层是一些客户端和连接服务，所包含的服务并不是MySQL所独有的技术。它们都是服务于C/S程序或者是这些程序所需要的 ：连接处理，身份验证，安全性等等。

### 2. 服务层(MySQL server)：
主要完成大多数的核心服务功能，如SQL 接口，并完成缓存的查询，SQL 的分析和优化及部分内置函数的执行。所有跨存储引擎的功能也在这一层上实现，如存储过程、触发器，视图等。在该层，服务器会解析并创建相应的内部数据结构（解析树），并完成相应的优化如重写查询、决定表的读取的顺序，选择合适的索引等，最后生成对应的执行操作。如果是select 语句，服务器还会先检查查询缓存（Query Cache），如果能够在其中找到对应的查询，服务器就不必再执行查询解析、优化和执行整个过程，而是直接返回查询缓存中的结果集。如果缓存空间足够大，这样在解决大量读操作的环境中能够很好的提升系统的性能。

### 3. 引擎层(Storage Engines)：
在存储引擎层，存储引擎真正的负责了MySql 中数据的存储和提取，服务器通过API 与存储引擎进行通信。这些接口屏蔽了不同存储引擎之间的差异，使得这些差异对上层的查询过程透明。存储引擎不会去解析SQL（InnoDB是一个例外，它会解析外键定义，因为MySQL服务器本身没有实现该功能），不同存储引擎之间也不会相互通信，而只是简单地响应上层服务器的请求。

### 4.存储层(File System)： 
数据存储层，主要将数据存储在运行于裸设备上的文件系统上，并完成与存储引擎的交互。



## 二. MySQL 主流引擎

特点| MyISAM | InnoDB
-|-|-
事物操作| N | Y
外键关联|N|Y
锁范围| 表级锁|支持行锁


1. MyISAM 仅支持表锁，在海量写入的时候，会导致所有查询处于Locked状态。
2. MySQL 5.1 以前版本默认使用 MyISAM, 5.5 版本以上默认 InnoDB。
3. MySQL 支持数据库内的不同表格使用不同的引擎，所以引擎设置一般在创建表格的时候。


## 三. MariaDB 的来源
1. MySQL被收购之后，面临着被闭源的风险，因此MySQL之父 Widenius离开Sun之后，2009年重新开发代码全部开源免费关系型数据库，推出了MariaDB。
2. MariaDB是MySQL的代码级量身定制的替代者，所以大部分功能相似，而且接口一样，相应的版本可以直接替换。

MySQL 版本|MariaDB 版本
-|-
5.5|5.5
5.6|10.0
5.7|10.1


## 四. MySQL 优化步骤
当数据达到千万级时，查询会变得慢下来，一般优化步骤如下
1. 优化的sql，使用索引
2. 添加缓存，比如 redis, memcached
3. 分库，读写分离，主库写数据，从库读，一般上层应用框架都支持读写分离的数据库配置。
4. 分区，将数据按照一定规则分布到多个区，避免全区扫描，也可以多个区并发处理；MySQL 自带的分区功能，对上层应用框架是透明的，但是存在多种限制功能，后面会说到。
5. 分表，比如根据自增ID每10万条记录分成一个表，应用程序根据ID再去操作具体的表格，这个需要上层应用框架配合修改，成本比较高，除非有足够的理由，否则不太建议。


