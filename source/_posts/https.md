---
title: https
date: 2020-06-29 07:00:14
tags: Linux
---

> https

<!-- more -->

## 一. https 协议简介
HTTPS协议 = HTTP协议 + SSL/TLS协议，在HTTPS数据传输的过程中，需要用SSL/TLS对数据进行加密和解密，需要用HTTP对加密后的数据进行传输，由此可以看出HTTPS是由HTTP和SSL/TLS一起合作完成的。

SSL的全称是Secure Sockets Layer，即安全套接层协议，是为网络通信提供安全及数据完整性的一种安全协议。SSL协议在1994年被Netscape发明，后来各个浏览器均支持SSL，其最新的版本是3.0

TLS的全称是Transport Layer Security，即安全传输层协议，最新版本的TLS（Transport Layer Security，传输层安全协议）是IETF（Internet Engineering Task Force，Internet工程任务组）制定的一种新的协议，它建立在SSL 3.0协议规范之上，是SSL 3.0的后续版本。在TLS与SSL3.0之间存在着显著的差别，主要是它们所支持的加密算法不同，所以TLS与SSL3.0不能互操作。虽然TLS与SSL3.0在加密算法上不同，但是在我们理解HTTPS的过程中，我们可以把SSL和TLS看做是同一个协议。

## 二. https 交互过程
HTTPS为了兼顾安全与效率，同时使用了对称加密和非对称加密。数据是被对称加密传输的，对称加密过程需要客户端的一个密钥，为了确保能把该密钥安全传输到服务器端，采用非对称加密对该密钥进行加密传输，总的来说，对数据进行对称加密，对称加密所要使用的密钥通过非对称加密传输。

![](/img/2020/https_1.jpg)

1. 客户端向服务器发起第一次HTTPS请求，连接到服务器的443端口

2. 服务器端有一个密钥对，即公钥和私钥，是用来进行非对称加密使用的，服务器端保存着私钥，不能将其泄露，公钥可以发送给任何人。

3. 服务器将自己的公钥发送给客户端。

4. 客户端收到服务器端的证书之后，会对证书进行检查，验证其合法性，如果发现发现证书有问题，那么HTTPS传输就无法继续。

5. 如果公钥合格，那么客户端会生成一个随机值，这个随机值就是用于进行对称加密的密钥，我们将该密钥称之为client key，即客户端密钥，这样在概念上和服务器端的密钥容易进行区分。然后用服务器的公钥对客户端密钥进行非对称加密，这样客户端密钥就变成密文了，至此，HTTPS中的第一次HTTP请求结束。

6. 客户端会发起HTTPS中的第二个请求，将加密之后的客户端密钥发送给服务器。

7. 服务器接收到客户端发来的密文之后，会用自己的私钥对其进行非对称解密，解密之后的明文就是客户端密钥 client key，然后用客户端密钥对将要返回的内容进行对称加密，这样数据就变成了密文。

8. 然后服务器将加密后的返回数据发送给客户端。

9. 客户端收到服务器发送来的数据，用客户端密钥 client key 对其进行对称解密，得到服务器发送的数据。这样HTTPS中的第二个请求结束，整个HTTPS传输完成。


## 三. 疑问解答

1. 为什么数据传输是用对称加密?
首先，非对称加密的加解密效率是非常低的，而 HTTP 的应用场景中通常端与端之间存在大量的交互，非对称加密的效率是无法接受的。

2. 为什么需要 CA 认证机构颁发证书?
HTTP 协议被认为不安全是因为传输过程容易被监听者勾线监听、伪造服务器，HTTPS 协议通过 CA 认证证书，可以防止“中间人攻击”
“中间人攻击”过程原理如下：
- 本地请求被劫持(如 DNS 劫持等)，所有请求均发送到中间人的服务器。
- 中间人服务器返回中间人自己的证书。
- 客户端创建随机数，通过中间人证书的公钥对随机数加密后传送给中间人，然后凭随机数构造对称加密对传输内容进行加密传输。
- 中间人因为拥有客户端的随机数，可以通过对称加密算法进行内容解密。
- 中间人以客户端的请求内容再向正规网站发起请求。
- 因为中间人与服务器的通信过程是合法的，正规网站通过建立的安全通道返回加密后的数据。
- 中间人凭借与正规网站建立的对称加密算法对内容进行解密。
- 中间人通过与客户端建立的对称加密算法对正规内容返回的数据进行加密传输。
- 客户端通过与中间人建立的对称加密算法对返回结果数据进行解密。


![](/img/2020/https_2.jpg)

3. 浏览器是如何确保 CA 证书的合法性?
- 证书包含什么信息?
颁发机构信息：公钥，公司信息，域名，有效期，指纹

- 证书的合法性依据是什么?
首先，权威机构是要有认证的，不是随便一个机构都有资格颁发证书，不然也不叫做权威机构。
另外，证书的可信性基于信任制，权威机构需要对其颁发的证书进行信用背书，只要是权威机构生成的证书，我们就认为是合法的。
所以权威机构会对申请者的信息进行审核，不同等级的权威机构对审核的要求也不一样，于是证书也分为免费的、便宜的和贵的。

- 浏览器如何验证证书的合法性?
浏览器发起 HTTPS 请求时，服务器会返回网站的 SSL 证书。
浏览器需要对证书做以下验证：
验证域名、有效期等信息是否正确。证书上都有包含这些信息，比较容易完成验证。
判断证书来源是否合法。每份签发证书都可以根据验证链查找到对应的根证书，操作系统、浏览器会在本地存储权威机构的根证书，利用本地根证书可以对对应机构签发证书完成来源验证。
判断证书是否被篡改。需要与 CA 服务器进行校验。
判断证书是否已吊销。通过 CRL(Certificate Revocation List 证书注销列表)和 OCSP(Online Certificate Status Protocol 在线证书状态协议)实现。
其中 OCSP 可用于第 3 步中以减少与 CA 服务器的交互，提高验证效率。
以上任意一步都满足的情况下浏览器才认为证书是合法的。

![](/img/2020/https_3.jpg)


这里插一个我想了很久的但其实答案很简单的问题：既然证书是公开的，如果要发起中间人攻击，我在官网上下载一份证书作为我的服务器证书，那客户端肯定会认同这个证书是合法的，如何避免这种证书冒用的情况?
其实这就是非加密对称中公私钥的用处，虽然中间人可以得到证书，但私钥是无法获取的。
一份公钥是不可能推算出其对应的私钥，中间人即使拿到证书也无法伪装成合法服务端，因为无法对客户端传入的加密数据进行解密。

- 只有认证机构可以生成证书吗?
如果需要浏览器不提示安全风险，那只能使用认证机构签发的证书。
但浏览器通常只是提示安全风险，并不限制网站不能访问，所以从技术上谁都可以生成证书，只要有证书就可以完成网站的 HTTPS 传输。
例如早期的 12306 采用的便是手动安装私有证书的形式实现 HTTPS 访问。

![](/img/2020/https_4.jpg)


4. 如何解决报文可能遭篡改问题
网络传输过程中需要经过很多中间节点，虽然数据无法被解密，但可能被篡改。
通过校验数据的数字签名，可以确保是否被篡改，类似 MD5 、hash算法的数字签名
数字签名有两种功效：
能确定消息确实是由发送方签名并发出来的，因为别人假冒不了发送方的签名。
数字签名能确定消息的完整性,证明数据是否未被篡改过。
数字签名如何生成:
将一段文本先用Hash函数生成消息摘要，然后用发送者的私钥加密生成数字签名，与原文文一起传送给接收者。接下来就是接收者校验数字签名的流程了。
校验数字签名流程：假设有节点 A (服务端)要向节点 B (浏览器)发送一段报文：
- 节点A为要发送的报文生成摘要（例如md5）
- 节点A用自己的私钥对摘要执行签名函数生成数字签名
- 节点A把数字签名附在要发送的报文之后，然后把报文和签名一块发送给节点B
- 节点B收到报文后，先取出数字签名部分，用公钥对签名执行反签名函数得到摘要
- 节点B对报文部分生成摘要（例如md5）
- 节点B对 4、5 两个步骤得到的两个摘要进行比较
- 如果一致，则可以认为报文是未被篡改过的
