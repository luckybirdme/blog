---
title: OSI 网络层
date: 2020-05-17 21:52:13
tags: Linux
---

> 网络层

<!-- more -->


### 1. 位置
网络层位于 OSI 的第三层

### 2. 协议
- IP (Internet Protocol) 网际互连协议，即 IPv4，IPv6 协议
主要定义IP编址方案、分组封装格式及分组转发规则，是整个TCP/IP协议族的核心，也是构成互联网的基础。

- ICMP (Internet Control Message Protocol) Internet 控制报文协议。
用于在IP主机、路由器之间传递控制消息。控制消息是指网络通不通、主机是否可达、路由是否可用等网络本身的消息。这些控制消息虽然并不传输用户数据，但是对于用户数据的传递起着重要的作用。
ping 和 tracert是两个常用网络管理命令，ping 用来测试网络可达性，tracert 用来显示到达目的主机的路径。ping和 tracert 都利用 ICMP 协议来实现网络功能。

- ARP (Address Resolution Protocol) 地址解析协议，将 IP 地址转换为 MAC 地址。
路由器确定下一个网关地址时，需要根据网关的IP地址，转换成 MAC 地址，然后传给链路层转发。

- RARP(Reverse Address Resolution Protocol) 反向地址转换协议，将 MAC 地址转换为 IP 地址


### 3. 数据
以 IPv4 协议为例子

![](/img/2020/IP_one.png)

- 版本（Version）
版本字段指定了IP数据报中使用的IP协议版本，占四位。如过协议是IPV4，则值为0100。

- 头部长度（Header Length）
头部长度字段指示IP数据报头部的总长度，IP数据报头部的总长度以4字节为单位，该字段占4位。当报头中无选项字段时，报头的总长度为5，也就是5×4=20字节,此时，报头长度的值为0101。这就是说IP数据报头部固定部分长度为20字节。当IP头部长度为1111时，头部的固定长度为15×4=60字节。但报头长度必须是32位（4字节）的整数倍，如果不是，需要在选项字段的填充PAD 字段中补0凑齐。

- 区分服务（Differentialted Services）
最开始IP数据报的这个字段为优先级和服务类型字段，又称为服务类型（ToS）字段，用于表示数据报的优先级和服务类型，占八位。


- 总长度（Total Length）
总长度字段标识整个IP数据报的总长度，包括报头和数据部分，整个IP数据报的总长度以字节为单位，该字段占16位。由此可得出，IPv4数据报的最大长度为216−1字节即65535字节（64KB）。
说明：在网络层下面的每一种数据链路层都有自己的格式，其中包括表示数据字段的最大长度，这称为最大传送单元（Maximum Transfer Unit，MTU）。当一个数据报封装成链路层的帧时，此数据报的总长度（包括报头和数据部分）一定不能超过下面的数据链路层的MTU值。


- 标识（Identification）
标识字段用于表示IP数据报的标识符，占16位，每个IP数据报有一个唯一的标识符。IP软件在存储器中维持一个计数器，每产生一个数据报，计数器就加1，并将此值赋给整个标识字段。但整个标识并不是序号，因为IP是无连接服务，数据报不存在按序接受的问题。当数据报由于长度超过下面数据链路层的MTU（最大传输单元）值而必须分段的时候，这个标识符的值就被复制到所有的数据报分段的标识字段中。相同的标识字段的值分段后的各数据报分段最后能正确地组装成原来的数据报。

- 标志（Flags）
标志字段用以指出该IP数据报后面是否还有分段，也就是这个字段时分段标志，占3位。目前只有前两位有意义：最低以为记为MF（More Fragment），如果MF=1，则表示后面还有分段，如果MF=0表示这已是某个数据报的最后一个分段；中间一位记为DF（Don’t Fragment），当DF=1时表示不允许分段，DF=0表示允许分段；最高1位没有使用。

- 段偏移（Fragment Offset）
段偏移字段用以指出该分段在数据报中的相对位置，也就是说，相对于用户数据字段的起点，该分段从何处开始，占13位。若有分段，段偏移以8字节为偏移单位，即每个分段的长度一定是8字节（64位）的整数倍。第一个分段偏移值就是0 0000 0000 0000，如果第一个分段一共是64字节，则0 0000 0000 1001，相当于10进制数的9，因为从第9个“8字节”数据块开始的。如果没有分段，则该字段值为0。

- 生存时间（Time To Live）
生存时间字段用来标识IP数据报在网络中传输的有效期，以秒来计数，占8位。最初的设计是以秒为单位，没经过一个路由器时，就在TTL（Time To Live）中减去数据报在路由器消耗掉的一段时间。若数据报在路由器消耗的时间小于1s，就把TTL值减1。TTL的建议值是32s，最长是28−1=255s。现在通常认为这个TTL是指数据报允许经过的路由器数，每经过一个路由器，则TTL减1，当TTL值为0时，就丢弃这个数据报。设定生存时间是为了防止数据报在网络中无限制地循环转发。

- 协议（Protocol）
协议字段用来标识此IP数据报在传输层所采用的协议类型（如TCP、UDP或ICMP等等），以便使目的主机的IP层直到应将数据部分上交给哪个处理过程，占8位。如TCP的协议号是6，等于二进制的0000 1010，UDP的协议号是17，等于二进制的0001 0001。


- 校验和（Checksum）
校验和字段用来检验IP数据报的报头部分（不包过“数据”部分）在传输到接收端后是否发生了变化，占16位。这是因为数据报每经过一个路由器，路由器都要重新计算一下报头检验和（因为一些字段，如生存时间、标识、段偏移等都可能发生变化），不检验数据部分可减少计算的工作量。


- 源地址/目的地址（Source Address/Destination Address）
源地址/目的地址这两个字段分别表示该IP数据报发送者和接受者的IP地址，各占32位。在这个数据报传送过程中，无论经过什么路由，无论如何分段，此两字段一直保持不变。

- 选项（Option）
选项字段支持各种选项，提供扩展余地。根据选项的不同，该字段时可变长，从1字节到40字节。用来支持拍错、测量以及安全等措施。作为选项，用户可以使用，也可以不使用它们。但作为IP协议的组成部分，所有实现IP协议的设备都必须能处理IP选项。在使用选项的过程中，如果造成了IP数据报的报头不是32位的整数倍，这时需要后面的填充字段凑齐。如果恰好是整数倍，则不需要填充字段。




### 4. 具体实现
路由器，NAT 网络，三层交换机


